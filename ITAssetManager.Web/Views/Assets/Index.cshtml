@model IEnumerable<ITAssetManager.Web.Models.Asset>
@using Microsoft.AspNetCore.Identity
@inject UserManager<ApplicationUser> UserManager

@{
    ViewData["Title"] = "Assets";
    var isAdmin = User?.IsInRole("Administrator") == true;
    var isAdminOrDev = User?.IsInRole("Administrator") == true || User?.IsInRole("Developer") == true;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>Assets</h1>

        @* Only Administrators can create new assets *@
        @if (isAdmin)
        {
            <a asp-action="Create" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Create New Asset
            </a>
        }
    </div>

    @* Success/Error Messages *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @* Search and Sort Form *@
    <form method="get" class="mb-3">
        <div class="row g-2">
            <div class="col-md-6">
                <input type="text" name="q" value="@ViewBag.Q"
                       class="form-control" placeholder="Search by tag, model, serial number, or person...">
            </div>
            <div class="col-md-3">
                <select name="sort" class="form-select">
                    <option value="tag" selected="@(ViewBag.Sort == "tag")">Sort by Tag</option>
                    <option value="model" selected="@(ViewBag.Sort == "model")">Sort by Model</option>
                    <option value="status" selected="@(ViewBag.Sort == "status")">Sort by Status</option>
                </select>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="bi bi-search"></i> Search
                </button>
            </div>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Asset Tag</th>
                    <th>Category</th>
                    <th>Model</th>
                    <th>Serial Number</th>
                    <th>Purchase Date</th>

                    @* Only show Purchase Cost to Admin and Developer *@
                    @if (isAdminOrDev)
                    {
                        <th>Purchase Cost</th>
                    }

                    <th>Warranty End</th>
                    <th>Status</th>
                    <th>Location</th>
                    <th>Assigned To</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    @foreach (var item in Model)
                    {
                        <tr>
                            <td>@(item.AssetTag ?? "N/A")</td>
                            <td>@(item.Category ?? "N/A")</td>
                            <td>@(item.Model ?? "N/A")</td>
                            <td>@(item.SerialNumber ?? "N/A")</td>
                            <td>@(item.PurchaseDate?.ToString("yyyy-MM-dd") ?? "N/A")</td>

                            @* Only show Purchase Cost to Admin and Developer *@
                            @if (isAdminOrDev)
                            {
                                <td>@(item.PurchaseCost?.ToString("C") ?? "N/A")</td>
                            }

                            <td>@(item.WarrantyEnd?.ToString("yyyy-MM-dd") ?? "N/A")</td>
                            <td>
                                <span class="badge bg-@(item.Status == "Active" ? "success" : "secondary")">
                                    @(item.Status ?? "N/A")
                                </span>
                            </td>
                            <td>@(item.Location != null ? $"{item.Location.Building} - {item.Location.Room}" : "N/A")</td>
                            <td>@(item.Person?.FullName ?? "Unassigned")</td>
                            <td class="text-nowrap">
                                @* All authenticated users can view details *@
                                <a asp-action="Details" asp-route-id="@item.Id"
                                   class="btn btn-sm btn-outline-info" title="View Details">
                                    <i class="bi bi-eye"></i> Details
                                </a>

                                @* Only Admin or Developer can edit *@
                                @if (isAdminOrDev)
                                {
                                    <a asp-action="Edit" asp-route-id="@item.Id"
                                       class="btn btn-sm btn-outline-primary" title="Edit Asset">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>
                                }

                                @* Only Administrator can delete *@
                                @if (isAdmin)
                                {
                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteModal-@item.Id"
                                            title="Delete Asset">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>

                                    <!-- Delete Confirmation Modal -->
                                    <div class="modal fade" id="deleteModal-@item.Id" tabindex="-1"
                                         aria-labelledby="deleteModalLabel-@item.Id" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header bg-danger text-white">
                                                    <h5 class="modal-title" id="deleteModalLabel-@item.Id">
                                                        <i class="bi bi-exclamation-triangle"></i> Confirm Delete
                                                    </h5>
                                                    <button type="button" class="btn-close btn-close-white"
                                                            data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>Are you sure you want to delete this asset?</p>
                                                    <ul class="list-unstyled">
                                                        <li><strong>Asset Tag:</strong> @item.AssetTag</li>
                                                        <li><strong>Model:</strong> @item.Model</li>
                                                        <li><strong>Serial Number:</strong> @item.SerialNumber</li>
                                                    </ul>
                                                    <div class="alert alert-warning">
                                                        <i class="bi bi-exclamation-triangle"></i>
                                                        This action cannot be undone!
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                            data-bs-dismiss="modal">
                                                        Cancel
                                                    </button>
                                                    <form asp-action="Delete" asp-route-id="@item.Id"
                                                          method="post" class="d-inline">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-danger">
                                                            <i class="bi bi-trash"></i> Delete
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="@(isAdminOrDev ? 11 : 10)" class="text-center text-muted">
                            <i class="bi bi-inbox"></i> No assets found.
                            @if (isAdmin)
                            {
                                <a asp-action="Create" class="ms-2">Create your first asset</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @* Pagination *@
    @if (ViewBag.Total > ViewBag.PageSize)
    {
        var totalPages = (int)Math.Ceiling((double)ViewBag.Total / ViewBag.PageSize);
        var currentPage = ViewBag.Page;

        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-q="@ViewBag.Q"
                       asp-route-sort="@ViewBag.Sort"
                       asp-route-page="@(currentPage - 1)">
                        Previous
                    </a>
                </li>

                @for (int i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-q="@ViewBag.Q"
                           asp-route-sort="@ViewBag.Sort"
                           asp-route-page="@i">
                            @i
                        </a>
                    </li>
                }

                <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                    <a class="page-link"
                       asp-action="Index"
                       asp-route-q="@ViewBag.Q"
                       asp-route-sort="@ViewBag.Sort"
                       asp-route-page="@(currentPage + 1)">
                        Next
                    </a>
                </li>
            </ul>
        </nav>

        <p class="text-center text-muted">
            Showing page @currentPage of @totalPages (Total: @ViewBag.Total assets)
        </p>
    }
</div>

@section Scripts {
    <script>
        // Auto-hide alert messages after 3 seconds
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 3000);
    </script>
}